<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Pipeline Web CLI</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm@4.19.0/css/xterm.css">
    <script src="https://unpkg.com/xterm@4.19.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            overflow: hidden;
        }
        .header {
            background: #2d2d30;
            color: #cccccc;
            padding: 10px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #569cd6;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }
        .status-indicator.connected {
            background: #28a745;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn:hover {
            background: #106ebe;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #terminal-container {
            height: calc(100vh - 60px);
            padding: 0;
        }
        #terminal {
            height: 100%;
            width: 100%;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            .header h1 {
                font-size: 16px;
            }
            .status {
                gap: 10px;
            }
            .btn {
                font-size: 14px;
                padding: 8px 12px;
            }
            #terminal-container {
                height: calc(100vh - 80px);
            }
        }
        
        /* Authentication modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .auth-modal.hidden {
            display: none;
        }
        .auth-form {
            background: #2d2d30;
            padding: 30px;
            border-radius: 8px;
            color: #cccccc;
            min-width: 300px;
        }
        .auth-form h2 {
            margin-top: 0;
            color: #569cd6;
        }
        .auth-form input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #cccccc;
            border-radius: 3px;
        }
        .auth-form button {
            width: 100%;
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .error {
            color: #dc3545;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-form">
            <h2>üîê TikTok Pipeline Access</h2>
            <p>Enter your secure access code to connect to the terminal:</p>
            <input type="password" id="accessCode" placeholder="Secure Access Code" autocomplete="current-password">
            <small style="color: #888; display: block; margin-top: 5px;">
                üîí End-to-end encrypted Azure communication
            </small>
            <div id="authError" class="error hidden"></div>
            <button onclick="authenticate()">Connect</button>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="header">
        <h1>üé¨ TikTok Pipeline Web CLI</h1>
        <div class="status">
            <div>
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="controls">
                <button class="btn" onclick="clearTerminal()">Clear</button>
                <button class="btn" onclick="reconnect()">Reconnect</button>
                <button class="btn" onclick="showHelp()">Help</button>
            </div>
        </div>
    </div>
    
    <div id="terminal-container">
        <div id="terminal"></div>
    </div>

    <script>
        let term, fitAddon, socket;
        let accessToken = '';
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // Azure Function endpoint (secure Azure-to-Azure communication)
        const BACKEND_URL = 'https://tiktok-pipeline-functions.azurewebsites.net/api/webcli';
        
        // Direct Container App URLs
        const CONTAINER_APP_URL = 'http://4.227.71.172:7681'; // ttyd terminal
        const CONTAINER_API_URL = 'http://4.227.71.172:8000'; // FastAPI
        
        function initTerminal() {
            term = new Terminal({
                theme: {
                    background: '#1e1e1e',
                    foreground: '#cccccc',
                    cursor: '#ffffff',
                    selection: '#264f78'
                },
                fontSize: 14,
                fontFamily: '"Cascadia Code", "Consolas", "Courier New", monospace',
                cursorBlink: true,
                cursorStyle: 'block',
                scrollback: 1000
            });
            
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(document.getElementById('terminal'));
            fitAddon.fit();
            
            // Welcome message
            term.writeln('\x1b[1;36m‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ\x1b[0m');
            term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[1;33müé¨ TikTok Pipeline Web CLI\x1b[0m                               \x1b[1;36m‚îÇ\x1b[0m');
            term.writeln('\x1b[1;36m‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\x1b[0m');
            term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[37mSecure terminal access to your Azure deployment\x1b[0m         \x1b[1;36m‚îÇ\x1b[0m');
            term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[90mConnecting to backend...\x1b[0m                                \x1b[1;36m‚îÇ\x1b[0m');
            term.writeln('\x1b[1;36m‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ\x1b[0m');
            term.writeln('');
            
            window.addEventListener('resize', () => {
                setTimeout(() => fitAddon.fit(), 100);
            });
        }
        
        function authenticate() {
            const code = document.getElementById('accessCode').value;
            if (!code) {
                showAuthError('Please enter an access code');
                return;
            }
            
            accessToken = code;
            document.getElementById('authModal').classList.add('hidden');
            connectToTerminal();
        }
        
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
        
        function connectToTerminal() {
            try {
                updateStatus('Connecting...', false);
                
                term.writeln('\x1b[33m‚Üí Connecting to TikTok Pipeline Terminal...\x1b[0m');
                
                // Hide terminal and show ttyd iframe
                document.getElementById('terminal').style.display = 'none';
                
                // Create iframe for ttyd terminal
                const iframe = document.createElement('iframe');
                iframe.src = `${CONTAINER_APP_URL}/?arg=${encodeURIComponent(accessToken)}`;
                iframe.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border: none;
                    background: #1e1e1e;
                `;
                iframe.onload = () => {
                    updateStatus('Connected', true);
                };
                iframe.onerror = () => {
                    updateStatus('Error', false);
                    term.writeln('\x1b[31m‚úó Failed to connect to terminal server\x1b[0m');
                    document.getElementById('terminal').style.display = 'block';
                };
                
                document.getElementById('terminal-container').appendChild(iframe);
                
            } catch (error) {
                updateStatus('Error', false);
                term.writeln('\x1b[31m‚úó Failed to connect: ' + error.message + '\x1b[0m');
                document.getElementById('terminal').style.display = 'block';
            }
        }
        
        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const indicator = document.getElementById('statusIndicator');
            if (connected) {
                indicator.classList.add('connected');
            } else {
                indicator.classList.remove('connected');
            }
        }
        
        function clearTerminal() {
            if (term) {
                term.clear();
            }
        }
        
        function reconnect() {
            // Remove existing iframe if any
            const existingIframe = document.querySelector('#terminal-container iframe');
            if (existingIframe) {
                existingIframe.remove();
            }
            document.getElementById('terminal').style.display = 'block';
            reconnectAttempts = 0;
            connectToTerminal();
        }
        
        function showHelp() {
            term.writeln('');
                         term.writeln('\x1b[1;36m‚ï≠‚îÄ‚îÄ‚îÄ TikTok Pipeline CLI Help ‚îÄ‚îÄ‚îÄ‚ïÆ\x1b[0m');
             term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[33mPipeline Commands:\x1b[0m              \x1b[1;36m‚îÇ\x1b[0m');
             term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[36m‚Ä¢ python -m tiktok_pipeline.cli stats\x1b[0m \x1b[1;36m‚îÇ\x1b[0m');
             term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[36m‚Ä¢ python -m tiktok_pipeline.cli run\x1b[0m   \x1b[1;36m‚îÇ\x1b[0m');
             term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[36m‚Ä¢ python -m tiktok_pipeline.cli categories\x1b[0m\x1b[1;36m‚îÇ\x1b[0m');
             term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[33mContainer Info:\x1b[0m                 \x1b[1;36m‚îÇ\x1b[0m');
             term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[36m‚Ä¢ curl http://20.171.201.193:8000/health\x1b[0m \x1b[1;36m‚îÇ\x1b[0m');
             term.writeln('\x1b[1;36m‚îÇ\x1b[0m \x1b[36m‚Ä¢ curl http://20.171.201.193:8000/stats\x1b[0m  \x1b[1;36m‚îÇ\x1b[0m');
             term.writeln('\x1b[1;36m‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ\x1b[0m');
            term.writeln('');
        }
        
         // ttyd handles terminal interaction directly - no custom input needed
         
         // Initialize on page load
         document.addEventListener('DOMContentLoaded', () => {
             initTerminal();
             
             // Show auth modal
             document.getElementById('authModal').classList.remove('hidden');
             
             // Focus on access code input
             document.getElementById('accessCode').focus();
             
             // Enter key in auth form
             document.getElementById('accessCode').addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                     authenticate();
                 }
             });
         });
    </script>
</body>
</html> 